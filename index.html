<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>OAuthèªè¨¼ç‰ˆ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº</title>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar/main.min.css' rel='stylesheet' />
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #auth-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4285F4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #auth-button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>
    
    <div id="auth-status" style="text-align: center; margin-bottom: 20px;">
        <p id="status-message">éå…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
        
        <button id="auth-button" onclick="initializeGis()">
            Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§äºˆå®šã‚’èª­ã¿è¾¼ã‚€
        </button>
    </div>
    
    <div id='calendar' style="display: none;"></div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar/index.global.min.js'></script>
    
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/ja.global.min.js'></script>

    <script>
        // ==========================================================
        // ã€é‡è¦ã€‘è¨­å®šãŒå¿…è¦ãªç®‡æ‰€
        // ==========================================================
        // ğŸš¨ YOUR_CLIENT_ID: GCPã§å–å¾—ã—ãŸOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
        const CLIENT_ID = '376485449787-sk76t7tgmigbmqgm4h2vkkgr72hq1kl5.apps.googleusercontent.com'; 
        
        // ğŸ“… YOUR_CALENDAR_ID: ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„éå…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å®Œå…¨ãªIDï¼ˆ@ä»¥é™ã‚‚å«ã‚€ï¼‰
        const CALENDAR_ID = 'family00380647251029661395@group.calendar.google.com'; 
        
        // ğŸ”’ ã‚¹ã‚³ãƒ¼ãƒ— (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚)
        const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
        // ==========================================================

        let calendar = null;
        let accessToken = null;

        // âœ… ä¿®æ­£ç‚¹: window.onload ã‚’ä½¿ç”¨ã—ã€å…¨ã¦ã®å¤–éƒ¨JSãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã¤
        window.onload = function() {
            var calendarEl = document.getElementById('calendar');

            // FullCalendarã®åˆæœŸè¨­å®š
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                
                // timeGridã¯ã‚³ã‚¢ã«å«ã¾ã‚Œã‚‹ãŸã‚ã€dayGridã¨googleCalendarãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æŒ‡å®š
                plugins: [ 'dayGrid', 'googleCalendar' ], 
                
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                googleCalendarApiKey: null, // OAuthèªè¨¼ã®ãŸã‚APIã‚­ãƒ¼ã¯ä½¿ç”¨ã—ãªã„
                eventSources: [], // èªè¨¼æˆåŠŸæ™‚ã«è¨­å®šã•ã‚Œã‚‹
                
                eventSourceFailure: function(error) {
                    console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¾ãŸã¯èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            });
        };
        
        // èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹)
        function initializeGis() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãŒå®Œäº†ã—ãŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', tokenResponse);
                        alert('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚„ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ããŸã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
                    accessToken = tokenResponse.access_token;
                    loadCalendarEvents(accessToken);
                },
            }).requestAccessToken(); // èªè¨¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã—ã€ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦FullCalendarã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã€è¡¨ç¤ºã™ã‚‹
        function loadCalendarEvents(token) {
            // window.onload ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
            if (!calendar) {
                 // ã¾ã  FullCalendar ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
                 setTimeout(() => loadCalendarEvents(token), 100);
                 return;
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã—ã€UIã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
            document.getElementById('status-message').textContent = 'èªè¨¼æˆåŠŸï¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...';
            document.getElementById('auth-status').style.display = 'none'; // ãƒ­ã‚°ã‚¤ãƒ³UIã‚’éè¡¨ç¤º
            document.getElementById('calendar').style.display = 'block'; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º

            // FullCalendarã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã«ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’è¨­å®š
            calendar.setOption('eventSources', [
                {
                    googleCalendarId: CALENDAR_ID,
                    // å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®š
                    headers: {
                        Authorization: 'Bearer ' + token
                    }
                }
            ]);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            calendar.render();
        }
        
        // Google Identity Services (GIS) ã®è¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.initializeGis = initializeGis; 
    </script>
</body>
</html>
