<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>OAuthèªè¨¼ç‰ˆ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æº</title>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
        }
        /* Googleã®ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ (å¿…é ˆã§ã¯ãªã„ãŒæ¨å¥¨) */
        .g_id_signin {
            display: block;
            margin: 10px auto;
            width: 200px; /* å¿…è¦ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºèª¿æ•´ */
        }
    </style>
</head>
<body>
    
    <div id="auth-status" style="text-align: center; margin-bottom: 20px;">
        <p id="status-message">Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®äºˆå®šã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
        
        <div id="g_id_onload"
             data-client_id="YOUR_CLIENT_ID" 
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-callback="handleCredentialResponse">
        </div>
    </div>
    
    <div id='calendar' style="display: none;"></div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js'></script>
    
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.10/index.global.min.js'></script>
    
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/ja.global.min.js'></script>

    <script>
        // ==========================================================
        // ã€é‡è¦ã€‘è¨­å®šãŒå¿…è¦ãªç®‡æ‰€
        // ==========================================================
        // ğŸš¨ ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        const CLIENT_ID = '376485449787-sk76t7tgmigbmqgm4h2vkkgr72hq1kl5.apps.googleusercontent.com'; 
        
        // ğŸ“… è¡¨ç¤ºã—ãŸã„Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDï¼ˆé€šå¸¸ã¯ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        const CALENDAR_ID = 'family00380647251029661395';
        
        // ğŸ”’ å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ— (ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚)
        const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
        // ==========================================================

        let calendar = null;
        let accessToken = null;

        document.addEventListener('DOMContentLoaded', function() {
            // FullCalendarã®åˆæœŸè¨­å®šï¼ˆèªè¨¼æƒ…å ±ãªã—ã§ã¯ã¾ã èª­ã¿è¾¼ã¾ãªã„ï¼‰
            var calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                plugins: [ 'dayGrid', 'timeGrid', 'googleCalendar' ], 
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                
                // APIã‚­ãƒ¼ã¯ä½¿ã‚ãšã€OAuthãƒˆãƒ¼ã‚¯ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
                googleCalendarApiKey: null,
                
                // eventSourcesã¯èªè¨¼æˆåŠŸæ™‚ã«å‹•çš„ã«è¨­å®šã—ã¾ã™
                eventSources: [], 
                
                // èªè¨¼å¤±æ•—æ™‚ã®ãŸã‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                eventSourceFailure: function(error) {
                    console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
            });
        });
        
        // èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹
        function initializeGis() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', tokenResponse);
                        return;
                    }
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ããŸã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
                    accessToken = tokenResponse.access_token;
                    loadCalendarEvents(accessToken);
                },
            }).requestAccessToken();
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•° (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã—ãŸå¾Œ)
        function handleCredentialResponse(response) {
            // FullCalendarãŒã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’èªè­˜ã§ãã‚‹ã‚ˆã†ã«ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«ä¿å­˜
            accessToken = response.access_token;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
            loadCalendarEvents(accessToken);
        }

        // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦FullCalendarã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã€è¡¨ç¤ºã™ã‚‹
        function loadCalendarEvents(token) {
            if (!calendar) return;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('status-message').textContent = 'èªè¨¼æˆåŠŸï¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...';
            document.getElementById('auth-status').style.display = 'none'; // ãƒ­ã‚°ã‚¤ãƒ³UIã‚’éè¡¨ç¤º
            document.getElementById('calendar').style.display = 'block'; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º

            // FullCalendarã®ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã«ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’è¨­å®š
            calendar.setOption('eventSources', [
                {
                    googleCalendarId: CALENDAR_ID,
                    // å–å¾—ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
                    // FullCalendarã¯ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™
                    headers: {
                        Authorization: 'Bearer ' + token
                    }
                }
            ]);

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            calendar.render();
        }
        
        // Googleã®èªè¨¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ (GISãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¦ä»¶)
        window.handleCredentialResponse = handleCredentialResponse;
        window.initializeGis = initializeGis;
        
    </script>
</body>
</html>
