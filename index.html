<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>OAuth認証版 Googleカレンダー連携</title>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        #calendar {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #auth-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4285F4; /* Google Blue */
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        #auth-button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>
    
    <div id="auth-status" style="text-align: center; margin-bottom: 20px;">
        <p id="status-message">非公開カレンダーの予定を表示するには、Googleアカウントでログインしてアクセスを許可してください。</p>
        
        <button id="auth-button" onclick="initializeGis()">
            Googleアカウントで予定を読み込む
        </button>
    </div>
    
    <div id='calendar' style="display: none;"></div>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js' defer></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.10/index.global.min.js' defer></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/ja.global.min.js' defer></script>

    <script>
        // ==========================================================
        // 【重要】設定が必要な箇所 (あなたの設定値を維持)
        // ==========================================================
        const CLIENT_ID = '376485449787-sk76t7tgmigbmqgm4h2vkkgr72hq1kl5.apps.googleusercontent.com';
        const CALENDAR_ID = 'it.is.shotaime@google.com'; 
        const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
        // ==========================================================

        let calendar = null;
        let accessToken = null;

        // window.onload + setTimeout のロジックは維持します
        window.onload = function() {
            setTimeout(function() {
                var calendarEl = document.getElementById('calendar');

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ja',
                    plugins: [ 'dayGrid', 'googleCalendar' ], 
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    googleCalendarApiKey: null,
                    eventSources: [],
                    
                    eventSourceFailure: function(error) {
                        console.error('カレンダーの読み込みに失敗しました:', error);
                        alert('カレンダーの読み込みに失敗しました。アクセス権限または認証トークンを確認してください。');
                    }
                });
            }, 50);
        };
        
        function initializeGis() {
            google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error('認証エラー:', tokenResponse);
                        alert('認証に失敗しました。GCPのクライアントIDとリダイレクトURLの設定を確認してください。');
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    loadCalendarEvents(accessToken);
                },
            }).requestAccessToken();
        }

        function loadCalendarEvents(token) {
            if (!calendar) {
                 setTimeout(() => loadCalendarEvents(token), 100);
                 return;
            }

            document.getElementById('status-message').textContent = '認証成功！カレンダーを読み込み中です...';
            document.getElementById('auth-status').style.display = 'none';
            document.getElementById('calendar').style.display = 'block';

            calendar.setOption('eventSources', [
                {
                    googleCalendarId: CALENDAR_ID,
                    headers: {
                        Authorization: 'Bearer ' + token
                    }
                }
            ]);

            calendar.render();
        }
        
        window.initializeGis = initializeGis; 
    </script>
</body>
</html>
